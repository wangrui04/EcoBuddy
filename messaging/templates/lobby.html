<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Start Chat</title>

  <style>
    /* Page base */
    body {
      background-color: #fff7e6;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      color: #222;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Header and Navigation */
    .header {
      background: #2c5f2d;
      padding: 15px 0;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      position: sticky;
      top: 0;
      z-index: 50;
    }

    .header-content {
      max-width: 900px;
      margin: 0 auto;
      padding: 0 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      color: #fff;
      font-size: 28px;
      font-weight: 700;
      text-decoration: none;
    }

    .nav-bar {
      max-width: 900px;
      margin: 0 auto;
      padding: 0 20px;
      background: transparent;
    }

    .nav-buttons {
      display: flex;
      gap: 8px;
      padding: 12px 0;
      justify-content: center;
    }

    .nav-btn {
      background: #4caf50;
      color: #fff;
      padding: 10px 16px;
      border-radius: 8px;
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.15s ease;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .nav-btn:hover {
      background: #45a049;
      transform: translateY(-1px);
    }

    .nav-btn.danger {
      background: #f44336;
    }

    .nav-btn.danger:hover {
      background: #da190b;
    }

    /* Page content area (centers the card below the header) */
    .page {
      display: flex;
      justify-content: center;
      padding: 36px 20px 80px 20px; /* top padding keeps card clear of header */
    }

    .container {
      background: #fff;
      width: 100%;
      max-width: 420px;
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      margin: 0 auto;
    }

    h2 {
      text-align: center;
      font-size: 26px;
      font-weight: 600;
      color: #2c5f2d;
      margin-bottom: 20px;
    }

    label {
      font-size: 15px;
      font-weight: 500;
      color: #2c5f2d;
      display: block;
      margin-bottom: 6px;
    }

    .input-field,
    select {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin-bottom: 15px;
      font-size: 15px;
      box-sizing: border-box;
    }

    button {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      background: #4caf50;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    button:hover {
      background: #45a049;
    }

    .messages {
      list-style: none;
      padding: 0;
      margin: 10px 0 20px 0;
      text-align: center;
    }

    .messages li {
      background: #f8d7da;
      color: #721c24;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 10px;
      border: 1px solid #f5c6cb;
      font-size: 14px;
    }

    .current-chats {
      margin-top: 25px;
    }

    .current-chats h3 {
      font-size: 20px;
      color: #2c5f2d;
      text-align: center;
      margin-bottom: 12px;
      font-weight: 600;
    }

    .current-chats ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .current-chats li {
      background: #f9f9f9;
      padding: 12px;
      border-radius: 10px;
      margin-bottom: 10px;
      text-align: center;
      cursor: pointer;
      transition: background 0.2s ease;
      border: 1px solid #e0e0e0;
    }

    .current-chats li:hover {
      background: #e8f5e9;
    }

    .home-btn {
      background: #2c5f2d !important;
      margin-top: 15px;
    }

    .home-btn:hover {
      background: #244d25 !important;
    }

    /* Search alignment (ensures same width as selects) */
    #user-search {
      width: 100%;
      box-sizing: border-box;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin-bottom: 15px;
      font-size: 15px;
    }

    /* Small screens tweak */
    @media (max-width: 480px) {
      .nav-buttons { gap: 6px; padding: 10px 0; }
      .container { padding: 24px; border-radius: 12px; }
    }
  </style>
</head>

<body>

  <!-- Header with Logo -->
  <div class="header">
    <div class="header-content">
      <a href="{% url 'home' %}" class="logo">üåç EcoBuddy</a>
      <div style="display: flex; align-items: center; gap: 15px;">
          <a href="{% url 'notifications' %}" style="position: relative; color: #fff; text-decoration: none; font-size: 24px;">
              üîî
              {% if unread_notifications_count > 0 %}
              <span style="position: absolute; top: -5px; right: -8px; background: #f44336; color: white; font-size: 11px; font-weight: bold; padding: 2px 6px; border-radius: 10px; min-width: 16px; text-align: center;">{{ unread_notifications_count }}</span>
              {% endif %}
          </a>
          <a href="{% url 'account_logout' %}" class="nav-btn danger">Logout</a>
      </div>
    </div>
  </div>

  <!-- Navigation Bar -->
  <div class="nav-bar">
    <div class="nav-buttons">
      <a href="{% url 'home' %}" class="nav-btn">üè† Home</a>
      <a href="{% url 'public_feed' %}" class="nav-btn">üì∞ Feed</a>
      <a href="{% url 'friends_list' %}" class="nav-btn">üë• Friends</a>
    </div>
  </div>

  <!-- Main page area -->
  <div class="page">
    <div class="container">

      <h2>Start a New Chat</h2>

      {% if messages %}
        <ul class="messages">
          {% for message in messages %}
            <li>{{ message }}</li>
          {% endfor %}
        </ul>
      {% endif %}

      {% if user.is_authenticated %}
        <p style="text-align:center; color:#2c5f2d; margin-bottom:20px;">
          Logged in as: <strong>{{ current_display_name }}</strong>
        </p>
      {% endif %}

      <!-- Start Group DM -->
      <form method="post" action="{% url 'messaging:lobby' %}">
        {% csrf_token %}

        <label>Select users to chat with or search users:</label>

        <input
          type="text"
          id="user-search"
          class="input-field"
          placeholder="Type to filter users..."
        >

        <select name="participants" id="participants" multiple required class="input-field">
          {% for u in users_with_names %}
            {% if u.user_obj != request.user %}
              <option value="{{ u.username }}">{{ u.display_name }}</option>
            {% endif %}
          {% endfor %}
        </select>

        <button type="submit">Start Chat</button>
      </form>

      <script>
        const userSearch = document.getElementById('user-search');
        const participantsSelect = document.getElementById('participants');

        userSearch.addEventListener('input', () => {
          const filter = userSearch.value.toLowerCase();
          for (let option of participantsSelect.options) {
            const text = option.text.toLowerCase();
            option.style.display = text.includes(filter) ? '' : 'none';
          }
        });
      </script>

      <!-- Current Chats -->
      <div class="current-chats">
        <h3>Your Current Chats</h3>
        <ul>
          {% for chat in current_chats %}
            <li onclick="location.href='{% url 'messaging:chat' chat_room_id=chat.id %}'">
              {{ chat.display_names|join:", " }}
            </li>
          {% empty %}
            <li>No active chats.</li>
          {% endfor %}
        </ul>
      </div>

    </div>
  </div>

</body>
</html>
