{% load static %}
{% load socialaccount %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EcoBuddy</title>
  <link rel="stylesheet" href="{% static 'css/styles.css' %}">
  <style>
    body {
      background-color: #fff7e6;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      color: #222;
      margin: 0;
      padding: 0;
    }

    /* Header and Navigation */
    .header {
      background: #2c5f2d;
      padding: 15px 0;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .header-content {
      max-width: 900px;
      margin: 0 auto;
      padding: 0 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      color: #fff;
      font-size: 28px;
      font-weight: 700;
      text-decoration: none;
    }

    .nav-bar {
      max-width: 900px;
      margin: 0 auto;
      padding: 0 20px;
    }

    .nav-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 15px 0;
    }

    .nav-btn {
      background: #4caf50;
      color: #fff;
      padding: 10px 18px;
      border-radius: 8px;
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s ease;
      border: none;
      cursor: pointer;
    }

    .nav-btn:hover {
      background: #45a049;
      transform: translateY(-1px);
    }

    .nav-btn.secondary {
      background: #fff;
      color: #2c5f2d;
      border: 2px solid #2c5f2d;
    }

    .nav-btn.secondary:hover {
      background: #e8f5e9;
    }

    .nav-btn.danger {
      background: #f44336;
    }

    .nav-btn.danger:hover {
      background: #da190b;
    }

    .nav-btn.warning {
      background: #ff9800;
    }

    .nav-btn.warning:hover {
      background: #f57c00;
    }

    .container {
      max-width: 900px;
      margin: 30px auto;
      background: #fff;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    }

    .profile-img {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid #4caf50;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .placeholder {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #2c5f2d;
      font-size: 14px;
      border: 4px solid #4caf50;
    }

    .btn {
      background: #4caf50;
      color: #fff;
      padding: 10px 20px;
      border-radius: 8px;
      text-decoration: none;
      border: none;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.2s ease;
    }

    .btn:hover {
      background: #45a049;
    }

    .section-card {
      background: #f9f9f9;
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
      border: 1px solid #e0e0e0;
    }

    .section-title {
      font-size: 20px;
      font-weight: 600;
      color: #2c5f2d;
      margin-bottom: 15px;
    }

    .message {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .message.success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .message.error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .message.info {
      background-color: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    .profile-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .profile-list li {
      padding: 10px 0;
      border-bottom: 1px solid #eee;
      font-size: 16px;
    }

    .profile-list li:last-child {
      border-bottom: none;
    }

    .profile-list strong {
      color: #2c5f2d;
    }

    .badge-container {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }

    .badge-item {
      text-align: center;
      padding: 15px;
      background: #fff;
      border-radius: 12px;
      min-width: 80px;
    }

    .badge-icon {
      font-size: 40px;
      display: block;
    }

    .badge-label {
      font-size: 12px;
      color: #666;
      margin-top: 8px;
    }

    .mod-notice {
      background: #fff3cd;
      color: #856404;
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
      border: 1px solid #ffc107;
    }

    .admin-notice {
      background: #e3f2fd;
      color: #1565c0;
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
      border: 1px solid #2196f3;
    }

    .login-container {
      text-align: center;
      padding: 60px 20px;
    }

    .login-container h2 {
      color: #2c5f2d;
      margin-bottom: 20px;
    }

    .login-container p {
      color: #666;
      margin-bottom: 30px;
    }
  </style>
</head>

{% if show_onboarding %}
<div id="onboarding-overlay" style="
    position: fixed; top:0; left:0;
    width:100%; height:100%;
    background: rgba(0,0,0,0.6);
    display:flex; justify-content:center; align-items:center;
    z-index:9999;">
    
    <div style="
        background:#fff;
        padding:30px;
        border-radius:20px;
        width:90%; max-width:420px;
        box-shadow:0 20px 40px rgba(0,0,0,0.2);
        text-align:center;">
        
        <h2 style="font-size:26px; margin-bottom:10px;">Welcome to EcoBuddy üåç</h2>
        <p style="font-size:16px; color:#555; margin-bottom:20px;">
            Choose the sustainability topics you're most interested in.
        </p>

        <form method="POST" action="{% url 'finish_onboarding' %}">
            {% csrf_token %}

            <div style="text-align:left; margin-bottom:20px;">
                {% for key, label in topics %}
                <label style="
                    display:block;
                    padding:8px;
                    margin-bottom:6px;
                    border:1px solid #ddd;
                    border-radius:8px;
                    cursor:pointer;">
                    <input type="checkbox" name="topics" value="{{ key }}">
                    {{ label }}
                </label>
                {% endfor %}
            </div>

            <label style="display:block; text-align:left; margin:15px 0;">
    <input type="checkbox" name="agree" required>
    I agree to follow the EcoBuddy community norms:
</label>
<p style="margin-left:25px; font-size:14px; color:#555;">
    1. Be respectful to all users.<br>
    2. Avoid offensive or harmful content.<br>
    3. Report any inappropriate behavior to moderators.<br>
    Failure to follow these norms may result in account suspension.<br><br>
    We hope you enjoy your EcoBuddy experience!
</p>

            <button type="submit" style="
                background:#34a853;
                color:white;
                padding:10px 16px;
                border:none;
                border-radius:8px;
                cursor:pointer;
                font-size:16px;">
                Finish Setup
            </button>
        </form>
    </div>
</div>
{% endif %}


<body>
  {% if user.is_authenticated %}
  <!-- Header with Logo -->
  <div class="header">
    <div class="header-content">
      <a href="{% url 'home' %}" class="logo">üåç EcoBuddy</a>
      <div style="display: flex; align-items: center; gap: 15px;">
        <a href="{% url 'notifications' %}" style="position: relative; color: #fff; text-decoration: none; font-size: 24px;">
          üîî
          {% if unread_notifications_count > 0 %}
          <span style="position: absolute; top: -5px; right: -8px; background: #f44336; color: white; font-size: 11px; font-weight: bold; padding: 2px 6px; border-radius: 10px; min-width: 16px; text-align: center;">{{ unread_notifications_count }}</span>
          {% endif %}
        </a>
        <a href="{% url 'account_logout' %}" class="nav-btn danger">Logout</a>
      </div>
    </div>
  </div>

  <!-- Navigation Bar -->
  <div class="nav-bar">
    <div class="nav-buttons">
      <a href="{% url 'public_feed' %}" class="nav-btn">üì∞ Feed</a>
      <a href="{% url 'friends_list' %}" class="nav-btn">üë• Friends</a>
      <a href="{% url 'user_search' %}" class="nav-btn">üîç Find Users</a>
      <a href="{% url 'user_profile' user.username %}" class="nav-btn">üë§ My Profile</a>
      <a href="{% url 'post_page' %}" class="nav-btn">üìù My Posts</a>
      <a href="{% url 'create_post' %}" class="nav-btn">‚ûï Create Post</a>
      <a href="{% url 'messaging:lobby' %}" class="nav-btn secondary">üí¨ Messaging</a>
      <a href="{% url 'account_settings' %}" class="nav-btn secondary">‚öôÔ∏è Settings</a>
      {% if profile and profile.can_moderate %}
      <a href="{% url 'moderation_dashboard' %}" class="nav-btn warning">üõ°Ô∏è Moderation</a>
      {% endif %}
      {% if profile and profile.role == 'admin' %}
      <a href="{% url 'admin_page' %}" class="nav-btn warning">üëë Admin</a>
      {% endif %}
    </div>
  </div>

  <!-- Messages -->
  {% if messages %}
  <div style="max-width: 900px; margin: 0 auto; padding: 0 20px;">
    {% for message in messages %}
    <div class="message {% if message.tags %}{{ message.tags }}{% endif %}">
      {{ message }}
    </div>
    {% endfor %}
  </div>
  {% endif %}

  {% if profile %}
  <div class="container">
    <h2 style="font-size:28px; font-weight:600; color: #2c5f2d; margin-bottom: 20px;">Welcome back, {{ userinfo.display_name|default:user.username }}!</h2>

    <!-- Profile picture -->
    <div style="margin: 20px 0;">
      {% if profile.profile_picture %}
      <img src="{{ profile.profile_picture.url }}" alt="Profile Picture" class="profile-img" />
      {% else %}
      <div class="placeholder">No photo</div>
      {% endif %}
    </div>

    <!-- Badges/Achievements Section -->
    <div class="section-card">
      <h3 class="section-title">üèÜ Achievements</h3>

      {% if has_any_achievement %}
        <div class="badge-container">

          {% if achievements.eco_starter %}
          <div class="badge-item">
            <span class="badge-icon">üå±</span>
            <p class="badge-label">Eco Starter</p>
          </div>
          {% endif %}

          {% if achievements.recycler %}
          <div class="badge-item">
            <span class="badge-icon">‚ôªÔ∏è</span>
            <p class="badge-label">Recycler</p>
          </div>
          {% endif %}

          {% if achievements.campus_steward %}
          <div class="badge-item">
            <span class="badge-icon">üçÉ</span>
            <p class="badge-label">Campus Steward</p>
          </div>
          {% endif %}

          {% if achievements.green_foodie %}
          <div class="badge-item">
            <span class="badge-icon">ü•ó</span>
            <p class="badge-label">Green Foodie</p>
          </div>
          {% endif %}

          {% if achievements.eco_commuter %}
          <div class="badge-item">
            <span class="badge-icon">üö¥</span>
            <p class="badge-label">Eco Commuter</p>
          </div>
          {% endif %}

        </div>
      {% else %}
        <p style="color:#666; font-size:14px;">
          You don't have any achievements yet. Create posts in different sustainability topics
          to unlock badges!
        </p>
      {% endif %}
    </div>



    <!-- Profile info (Read-only) -->
    <div class="section-card">
      <h3 class="section-title">üìã Profile Information</h3>
      <ul class="profile-list">
        <li><strong>Username:</strong> {{ user.username }}</li>
        <li><strong>Display Name:</strong> {{ userinfo.display_name|default:user.username }}</li>
        <li><strong>Email:</strong> {{ user.email }}</li>
        <li><strong>Bio:</strong> {{ userinfo.bio|default:"No bio yet" }}</li>
        <li><strong>Joined:</strong> {{ profile.joined_at|date:"F j, Y" }}</li>
        <li><strong>Interests:</strong>
          {% if preferred_topics_list %}
            {% for topic in preferred_topics_list %}
              {{ topic }}{% if not forloop.last %}, {% endif %}
            {% endfor %}
          {% else %}
            No interests selected
          {% endif %}
        </li>
      </ul>
    </div>

    {% if profile and profile.can_moderate %}
    <div class="mod-notice">
      <strong>üõ°Ô∏è Moderator Access</strong>
      <p style="margin: 10px 0 0 0;">You have moderator privileges. Use the Moderation button in the navigation bar to access moderation tools.</p>
    </div>
    {% endif %}

    {% if profile and profile.role == 'admin' %}
    <div class="admin-notice">
      <strong>üëë Administrator Access</strong>
      <p style="margin: 10px 0 0 0;">You have admin privileges. Use the Admin button in the navigation bar to manage the platform.</p>
    </div>
    {% endif %}
  </div>
  {% else %}
  <div class="container">
    <p style="text-align:center;">No profile info found. Please contact support.</p>
  </div>
  {% endif %}

  {% else %}
  <!-- Not logged in -->
  <div class="header">
    <div class="header-content">
      <span class="logo">üåç EcoBuddy</span>
    </div>
  </div>

  <div class="container login-container">
    <h2>Welcome to EcoBuddy!</h2>
    <p>Join our community of sustainability enthusiasts and make a positive impact on the environment.</p>
    <a class="btn" href="{% url 'account_login' %}">
      üöÄ Sign In To Get Started!
    </a>
  </div>
  {% endif %}
</body>

</html>